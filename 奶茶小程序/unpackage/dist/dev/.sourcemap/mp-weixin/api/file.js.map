{"version":3,"file":"file.js","sources":["api/file.js"],"sourcesContent":["import http from '@/api/index.js'\r\n\r\nconst prefix = '/globalApi'\r\n\r\nexport const upload = (files) => {\r\n    return new Promise((resolve, reject) => {\r\n        let response = {\r\n            code: 200,\r\n            data: [],\r\n        }\r\n        \r\n        if (!files || files.length === 0) {\r\n            resolve(response);\r\n            return;\r\n        }\r\n        \r\n        getUploadUrl(files)\r\n            .then(res => {\r\n                const resFile = res.data?.data || res.data // 兼容可能的返回结构\r\n                if (!resFile || !resFile.uploadUrl) {\r\n                     throw new Error('获取上传URL失败: 返回数据异常');\r\n                }\r\n\r\n                uploadFile(resFile.uploadUrl, files[0])\r\n                    .then(uploadRes => {\r\n                        // 兼容 uni.request 返回数组 [err, res] 或 Promise res 对象的情况\r\n                        const statusCode = uploadRes.statusCode || (Array.isArray(uploadRes) && uploadRes[1]?.statusCode);\r\n                        \r\n                        if (statusCode === 200) {\r\n                            const url = resFile.uploadUrl.split('?')[0];\r\n                            // 回调通知后端上传完成\r\n                            uploadCallback(resFile.id, url)\r\n                                .then(callbackRes => {\r\n                                    if (callbackRes && (callbackRes.data?.code === 200 || callbackRes.code === 200)) {\r\n                                        response.data.push(url);\r\n                                        resolve(response);\r\n                                    } else {\r\n                                        console.error('上传回调失败', callbackRes);\r\n                                        // 即使回调失败，文件可能已上传成功，但业务逻辑可能需要回调成功。\r\n                                        // 这里暂且认为失败\r\n                                        response.code = 999;\r\n                                        response.msg = '上传回调失败';\r\n                                        resolve(response);\r\n                                    }\r\n                                })\r\n                                .catch(err => {\r\n                                    console.error('上传回调异常:', err);\r\n                                    response.code = 999;\r\n                                    response.msg = '上传回调异常';\r\n                                    resolve(response);\r\n                                });\r\n                        } else {\r\n                            console.error('文件上传云存储失败:', uploadRes);\r\n                            response.code = 999;\r\n                            response.msg = `文件上传失败，状态码: ${statusCode}`;\r\n                            resolve(response);\r\n                        }\r\n                    })\r\n                    .catch(err => {\r\n                        console.error('上传文件过程异常:', err);\r\n                        response.code = 999;\r\n                        response.msg = '上传文件过程异常';\r\n                        resolve(response);\r\n                    });\r\n            })\r\n            .catch(err => {\r\n                console.error('获取上传URL异常:', err);\r\n                response.code = 999;\r\n                response.msg = '获取上传URL异常';\r\n                resolve(response);\r\n            });\r\n    });\r\n}\r\n\r\nexport const getUploadUrl = (files) => {\r\n    const file = files[0]\r\n    const filePath = file.path || file.tempFilePath;\r\n    return http.post(prefix + '/files/getUploadUrl', {\r\n        name: file.name.split('.')[0],\r\n        type: filePath.split('.').pop(),\r\n        size: file.size,\r\n        extType: filePath.split('.').pop(),\r\n        isPublic: 1\r\n    })\r\n}\r\n\r\n// 上传文件\r\nexport const uploadFile = async ( url, file ) => {\r\n    return uni.request({\r\n        url: url,\r\n        method: 'PUT',\r\n        data: await fileToArrayBuffer(file),\r\n        header: {\r\n            'Content-Type': 'application/octet-stream' // 显式指定流类型，防止默认 json\r\n        }\r\n    })\r\n}\r\n\r\nexport const uploadCallback = (id, url) => {\r\n    // 修正参数传递结构，假设后端需要 id 和 url\r\n    return http.post(prefix + `/files/callback`, {id: id, url: url})\r\n}\r\n\r\nexport const deleteFile = (id) => {\r\n    return http.delete(prefix + `/files`, {id: id})\r\n}\r\n\r\nfunction fileToArrayBuffer(file) {\r\n    return new Promise((resolve, reject) => {\r\n        if (!file) {\r\n            console.log('未选择文件');\r\n            reject(new Error('未选择文件'));\r\n            return;\r\n        }\r\n\r\n        // #ifdef H5\r\n        const reader = new FileReader();\r\n        reader.onload = function (e) {\r\n            resolve(e.target.result);\r\n        };\r\n        reader.onerror = function () {\r\n            console.error('文件读取错误:', reader.error);\r\n            reject(reader.error);\r\n        };\r\n        reader.readAsArrayBuffer(file);\r\n        // #endif\r\n\r\n        // #ifndef H5\r\n        // 小程序环境使用 uni.getFileSystemManager\r\n        const fs = uni.getFileSystemManager();\r\n        fs.readFile({\r\n            filePath: file.path || file.tempFilePath, // 兼容不同文件对象的路径属性\r\n            success: (res) => {\r\n                resolve(res.data); // res.data 就是 ArrayBuffer\r\n            },\r\n            fail: (err) => {\r\n                console.error('文件读取错误:', err);\r\n                reject(err);\r\n            }\r\n        });\r\n        // #endif\r\n    });\r\n}"],"names":["_a","uni","http"],"mappings":"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"}