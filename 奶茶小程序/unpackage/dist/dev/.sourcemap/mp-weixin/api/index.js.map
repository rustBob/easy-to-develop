{"version":3,"file":"index.js","sources":["api/index.js"],"sourcesContent":["// /utils/http.js\r\nimport { isInvalid, ubtoa } from \"@/util/common.js\";\r\nimport common from \"@/util/common.js\";\r\nimport Store from \"@/store\";\r\n\r\nconst baseURL = import.meta.env.VITE_HTTP_BASE_URL\r\n\r\n/**\r\n * 极简请求封装：\r\n * - 只管发请求\r\n * - 自动附带 token 到 header.token\r\n * - 失败直接 reject，交给调用方处理\r\n */\r\nconst http = (options) => {\r\n  const headers = Object.assign(\r\n    { 'Content-Type': 'application/json' },\r\n    { 'easyToken': Store.get('easyToken') || '' }, // 附带 cookie\r\n  );\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const task = uni.request({\r\n      url: `${baseURL}${options.url}`,\r\n      method: options.method || 'GET',\r\n      data: options.data || {},\r\n      timeout: 10000,\r\n      header: headers,\r\n      success: (res) => {\r\n        // 获取 cookie\r\n        res.cookies.forEach(cookie => {\r\n          cookie.split(';').forEach(item => {\r\n            const [key, value] = item.split('=');\r\n            if (key && value) {\r\n              Store.set(key, value);\r\n            }\r\n          })\r\n        });\r\n        resolve(res);\r\n      },\r\n      fail: (err) => reject(err)\r\n    });\r\n    resolve.abort = () => task?.abort?.();\r\n  });\r\n}\r\n\r\nexport default http\r\n\r\n// 拦截器\r\nuni.addInterceptor('request', { \r\n  invoke(args) { \r\n    if(args.url.includes('login') || args.url.includes('register')){\r\n      return true;\r\n    }\r\n    \r\n    if(!Store.get('easyToken') || !Store.get('user')){\r\n      uni.navigateTo({\r\n        url: '/pages/login/login'\r\n      });\r\n      return false;\r\n    }\r\n  },\r\n  success(res){\r\n    // 401 跳转登录页面\r\n    if(res.data.code === 401){\r\n      uni.showToast({\r\n        title: '登录过期，请重新登录(2s后自动跳转)',\r\n        icon: 'none',\r\n        duration: 2000\r\n      }).then(() => {\r\n        uni.navigateTo({\r\n          url: '/pages/login/login'\r\n        });\r\n      });\r\n      return false;\r\n    }\r\n  }\r\n});\r\n\r\n/**\r\n * 封装请求方法\r\n */\r\nhttp.get = (url, params = {}) =>\r\n  http({ url, data: params, method: 'GET' });\r\n\r\nhttp.post = (url, data = {}) =>\r\n  http({ url, data: data, method: 'POST' }); \r\n\r\nhttp.delete = (url, params = {}) =>\r\n  http({ url, data: params, method: 'DELETE' });\r\n\r\nhttp.put = (url, data = {}) =>\r\n  http({ url, data, method: 'PUT' });\r\n\r\n/**\r\n * 通用请求处理\r\n * @param reqPromise\r\n * @param success\r\n * @param failure\r\n * @returns {Promise<null>}\r\n */\r\nexport async function handleRequest(reqPromise, success, failure) {\r\n  let res;\r\n  try {\r\n    res = await reqPromise;\r\n  } catch (err) {\r\n    if (!err.msg) err.msg = err.message;\r\n    if (failure) failure(err);\r\n    return null;\r\n  }\r\n  if (res.statusCode !== 200 || (Object.prototype.hasOwnProperty.call(res.data, \"code\") && res.data.code !== 200)) {\r\n    if (res.notNotify) return null;\r\n\r\n    res.msg = res.data.message || \"网络错误，请稍后再试。\";\r\n    if (failure) failure(res);\r\n    return null;\r\n  }\r\n  \r\n  if (success) {\r\n    if (Object.prototype.hasOwnProperty.call(res.data, \"code\")) {\r\n      success(res.data.data);\r\n    } else {\r\n      success(res.data);\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * 构建路径（支持多级资源和参数）\r\n * @param versionPrefix 版本前缀 /globalApi\r\n * @param segments 资源分段数组（如 [\"activities\", \"stages\", \"projects\"]）\r\n * @param method 方法类型（all/add/delete/update/get）\r\n * @param pathParams 路径参数对象（如 { pk1: 123, pk2: 456 }）\r\n * @returns {string} 完整路径\r\n */\r\nexport function buildPath(versionPrefix, segments, method, pathParams = {}, suffix = ''){\r\n  let path = versionPrefix;\r\n  const depth = segments.length;\r\n\r\n  // 不同方法的参数规则\r\n  const isOptional = method === 'list'\r\n  const includeLastParam = method === 'update' || method === 'get';\r\n\r\n  pathParams = common.trimObj(pathParams);  \r\n\r\n  for (let i = 0; i < depth; i++) {\r\n    path += `/${segments[i]}`;\r\n    const pkKey = `pk${i + 1}`;\r\n    if (isInvalid(pathParams) || isInvalid(pathParams[pkKey])) {\r\n      continue;\r\n    }\r\n    const pkValue = ubtoa(pathParams[pkKey]);\r\n\r\n    // 非最后一段 或 需要包含最后参数（delete/update/get）\r\n    if (i < depth - 1 || includeLastParam) {\r\n      if (isOptional) {\r\n        // 可选参数格式: /segment/[:pk]\r\n        path += pkValue !== undefined ? `/${pkValue}` : `/[:${pkKey}]`;\r\n      } else {\r\n        // 必选参数格式: /segment/:pk\r\n        if (pkValue === undefined) throw new Error(`Missing required param: ${pkKey}`);\r\n        path += `/${pkValue}`;\r\n      }\r\n    }\r\n  }\r\n\r\n  suffix && (path += '/' + suffix);\r\n  \r\n  return path;\r\n}\r\n\r\nexport function generateCommonApis(prefix, resources) {\r\n  const apis = {};\r\n\r\n  const defaultFailure = err => uni.showToast({\r\n    title: err.message,\r\n    icon: 'none',\r\n    duration: 2000\r\n  });\r\n  \r\n  resources.forEach(resource => {\r\n    const segments = resource.split('/');\r\n\r\n    apis[resource] = {\r\n      // GET /v1/activities/[:pk1]/stages/[:pk2]/projects\r\n      list: async function (pathParams = {}, filterData = null, success = null, failure = defaultFailure, suffix = '') {\r\n                let url = buildPath(prefix, segments, 'list', pathParams, suffix + '/list');\r\n        if (filterData && typeof filterData === 'object') {\r\n          filterData = common.trimObj(filterData);\r\n          const query = Object.entries(filterData)\r\n              .map(([k, v]) => Array.isArray(v) ?\r\n                  v.map(e => `${k}[]=${ubtoa(e)}`).join('&')\r\n                  :\r\n                  `${k}=${ubtoa(v)}`\r\n              ).join('&');\r\n          url += `?${query}`;\r\n        }\r\n        return handleRequest(http.get(url, filterData), success, failure);\r\n      },\r\n\r\n      // POST /v1/activities/:pk1/stages/:pk2/projects\r\n      add: async function (pathParams = {}, addData = {}, success = null, failure = defaultFailure, suffix = '') {\r\n        let url = buildPath(prefix, segments, 'add', pathParams, suffix);\r\n        return handleRequest(http.post(url, common.trimObj(addData)), success, failure);\r\n      },\r\n\r\n      // DELETE /v1/activities/[:pk1]/stages/[:pk2]/projects/[:pk3]\r\n      delete: async function (pathParams = {}, deleteData = {}, success = null, failure = defaultFailure, suffix = '') {\r\n        let url = buildPath(prefix, segments, 'delete', pathParams, suffix);\r\n        if (deleteData && typeof deleteData === 'object') {\r\n          deleteData = common.trimObj(deleteData);\r\n          const query = Object.entries(deleteData)\r\n              .map(([k, v]) => Array.isArray(v) ?\r\n                  v.map(e => `${k}[]=${ubtoa(e)}`).join('&')\r\n                  :\r\n                  `${k}=${ubtoa(v)}`\r\n              ).join('&');\r\n          url += `?${query}`;\r\n        }\r\n        return handleRequest(http.delete(url), success, failure);\r\n      },\r\n\r\n      // PUT /v1/activities/:pk1/stages/:pk2/projects/:pk3\r\n      update: async function (pathParams = {}, updateData = {}, success = null, failure = defaultFailure, suffix = '') {\r\n        let url = buildPath(prefix, segments, 'update', pathParams, suffix);\r\n        return handleRequest(http.put(url, common.trimObj(updateData)), success, failure);\r\n      },\r\n\r\n      // GET /v1/activities/:pk1/stages/:pk2/projects/:pk3\r\n      get: async function (pathParams = {}, getParams = {}, success = null, failure = defaultFailure, suffix = '') {\r\n        let url = buildPath(prefix, segments, 'get', pathParams, suffix);\r\n        if (getParams && typeof getParams === 'object') {\r\n          getParams = common.trimObj(getParams);\r\n          const query = Object.entries(getParams)\r\n              .map(([k, v]) => Array.isArray(v) ?\r\n                  v.map(e => `${k}[]=${ubtoa(e)}`).join('&')\r\n                  :\r\n                  `${k}=${ubtoa(v)}`\r\n              ).join('&');\r\n          url += `?${query}`;\r\n        }\r\n        return handleRequest(http.get(url), success, failure);\r\n      }\r\n    };\r\n  });\r\n  return apis;\r\n}\r\n"],"names":["Store","uni","common","isInvalid","ubtoa"],"mappings":"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"}