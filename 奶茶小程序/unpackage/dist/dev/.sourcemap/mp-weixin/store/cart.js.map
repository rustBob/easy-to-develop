{"version":3,"file":"cart.js","sources":["store/cart.js"],"sourcesContent":["import { defineStore } from 'pinia';\nimport { useUserStore } from './user';\n\nexport const useCartStore = defineStore('cart', {\n    state: () => ({\n        items: [],\n        usePoints: false,\n        selectedCouponId: null,\n        orderType: 'pickup', // pickup, delivery\n        address: null,\n        store: null\n    }),\n    getters: {\n        totalCount: (state) => state.items.reduce((sum, item) => sum + item.drinksQuantity, 0),\n        \n        originalTotal: (state) => {\n            return state.items.reduce((sum, item) => sum + (item.price * item.drinksQuantity), 0);\n        },\n        \n        // Delivery Fee\n        deliveryFee: (state) => {\n            return state.orderType === 'delivery' ? 5 : 0;\n        },\n\n        // 1. Level Discount\n        levelDiscountAmount: (state) => {\n            const userStore = useUserStore();\n            if (!userStore.isLoggedIn) return 0;\n            // 黄金9.5折，钻石9折\n            const level = userStore.userInfo.level;\n            const rate = level === 2 ? 0.1 : (level === 1 ? 0.05 : 0);\n            return Math.floor(state.originalTotal * rate * 10) / 10;\n        },\n\n        // 2. Coupon Discount\n        couponDiscountAmount: (state) => {\n            const userStore = useUserStore();\n            if (!state.selectedCouponId || !userStore.isLoggedIn || !userStore.userInfo.couponList) return 0;\n            \n            const coupon = userStore.userInfo.couponList.find(c => c.id === state.selectedCouponId);\n            if (!coupon) return 0;\n\n            // Check min amount\n            if (state.originalTotal < coupon.minAmount) return 0;\n\n            if (coupon.type === 'cash') {\n                return coupon.value;\n            } else if (coupon.type === 'DISCOUNT') {\n                // Max discount 20 for 80% off\n                const discount = state.originalTotal * (1 - coupon.value);\n                return Math.floor(Math.min(discount, 20) * 10) / 10;\n            }\n            return 0;\n        },\n        \n        discountAmount: (state) => {\n             return parseFloat((state.levelDiscountAmount + state.couponDiscountAmount).toFixed(2));\n        },\n        \n        pointsDeduction: (state) => {\n            const userStore = useUserStore();\n            if (!state.usePoints || !userStore.isLoggedIn) return 0;\n            \n            // Calculate total after discounts\n            const amountAfterDiscount = state.originalTotal - state.levelDiscountAmount - state.couponDiscountAmount;\n            if (amountAfterDiscount <= 0) return 0;\n\n            // 100积分抵1元，最多抵扣50%\n            const maxDeduction = amountAfterDiscount * 0.5;\n            const pointsValue = userStore.userInfo.points / 100;\n            return Math.floor(Math.min(maxDeduction, pointsValue) * 100) / 100;\n        },\n        \n        finalTotal: (state) => {\n            let total = state.originalTotal - state.discountAmount - state.pointsDeduction + state.deliveryFee;\n            return Math.max(0, parseFloat(total.toFixed(2)));\n        }\n    },\n    actions: {\n        setOrderType(type) {\n            this.orderType = type;\n        },\n        setAddress(addr) {\n            this.address = addr;\n        },\n        setStore(store) {\n            this.store = store;\n        },\n        addToCart(product, specs, drinksQuantity = 1) {\n            const existing = this.items.find(c => c.id === product.id && c.specs === specs);\n            if (existing) {\n                existing.drinksQuantity += drinksQuantity;\n            } else {\n                this.items.push({\n                    ...product,\n                    specs,\n                    drinksQuantity,\n                    drinkId: product.id,\n                });\n                console.log(this.items);\n                \n            }\n        },\n        updateQty(index, delta) {\n            const item = this.items[index];\n            if (!item) return;\n            item.drinksQuantity += delta;\n            if (item.drinksQuantity <= 0) {\n                this.items.splice(index, 1);\n            }\n        },\n        selectCoupon(id) {\n            // Toggle\n            if (this.selectedCouponId === id) {\n                this.selectedCouponId = null;\n            } else {\n                this.selectedCouponId = id;\n            }\n        },\n        clearCart() {\n            this.items = [];\n            this.usePoints = false;\n            this.selectedCouponId = null;\n        }\n    }\n});\n"],"names":["defineStore","useUserStore","uni"],"mappings":"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"}