{"version":3,"file":"user.js","sources":["store/user.js"],"sourcesContent":["import { defineStore } from 'pinia';\nimport { globalApi } from '@/api/globalApi/index.js';\nimport Store from './index.js';\n\nexport const useUserStore = defineStore('user', {\n    state: () => ({\n        userInfo: {},\n        isLoggedIn: false,\n        token: null,\n        hasSharedToday: false\n    }),\n    getters: {\n        levelName: (state) => state.userInfo.levelName || '未登录',\n        points: (state) => state.userInfo.points || 0\n    },\n    actions: {\n        async deleteAccount() {\n            if (!this.userInfo.id) return false;\n            \n            try {\n                // Call DELETE /globalApi/users/:id\n                await globalApi['users'].delete(null, { id: this.userInfo.id }, (res) => {\n                    // 1. Clear local state\n                    this.logout();\n                    \n                    // 2. Show toast\n                    uni.showToast({ title: '账户已注销', icon: 'none' });\n                    \n                    // 3. Redirect to home or login\n                    uni.reLaunch({ url: '/pages/index/index' });\n                });\n                return true;\n            } catch (e) {\n                console.error('Delete account failed:', e);\n                uni.showToast({ title: '注销失败，请稍后重试', icon: 'none' });\n                return false;\n            }\n        },\n        async register(username, password, nickname) {\n            try {\n                await globalApi['auth'].register({username, password, nickname}, (res) => {\n                });\n                return true;\n            } catch (e) {\n                console.error(e);\n                throw e; // Rethrow to handle in component\n            }\n        },\n        async login(username, password) {\n            try {\n                await globalApi['auth'].login({username : username, password : password}, (res) => {\n                    this.token = res.token;\n                    this.isLoggedIn = true;\n                    Store.set('user', res);\n                    Store.set('easyToken', res.token);\n                    \n                    globalApi['users'].get(null, {id: res.id}, (res) => {\n                        this.userInfo = {\n                            ...res[0],\n                            avatar: res[0].avatar || \"https://api.dicebear.com/7.x/notionists/svg?seed=Felix\",\n                            levelName: res[0].memberCard.cardName,\n                            points: res[0].totalPoints || 0,\n                            level: res[0].memberCard.level || 0,\n                            cardId: res[0].memberCard.id || 0,\n                            coupons: res[0].couponList?.length || 0\n                        };\n                        this.isLoggedIn = true;\n                    });\n                });\n            } catch (e) {\n                console.error(e);\n                return false;\n            }\n        },\n        logout() {\n            this.userInfo = {};\n            this.isLoggedIn = false;\n        },\n        updateUserInfo(data) {\n            if (this.userInfo) {\n                this.userInfo = { ...this.userInfo, ...data };\n                // Also update local storage if needed, or rely on next fetch\n            }\n        },\n        updatePoints(points) {\n            if (this.userInfo) {\n                this.userInfo.points = points;\n            }\n        },\n        updateBalance(balance) {\n            if (this.userInfo) {\n                this.userInfo.balance = balance;\n            }\n        },\n        receiveShareCoupon() {\n            if (!this.hasSharedToday && this.userInfo) {\n                this.hasSharedToday = true;\n                // Add coupon logic (mock)\n                this.userInfo.coupons = (this.userInfo.coupons || 0) + 1;\n                // In real app, call API to add coupon\n            }\n        }\n    }\n});\n"],"names":["defineStore","globalApi","uni","Store","res"],"mappings":"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"}