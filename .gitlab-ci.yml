stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # 请在 GitLab CI/CD 设置中配置这些变量
  # DOCKER_REGISTRY_USER
  # DOCKER_REGISTRY_PASSWORD
  # DOCKER_REGISTRY_URL
  BACKEND_IMAGE: $DOCKER_REGISTRY_URL/milkytea-backend
  FRONTEND_IMAGE: $DOCKER_REGISTRY_URL/milkytea-frontend

# 后端单元测试
test_backend:
  image: maven:3.9.6-eclipse-temurin-21
  stage: test
  script:
    - cd easy-to-develop-back
    - mvn test
  artifacts:
    reports:
      junit: easy-to-develop-back/target/surefire-reports/*.xml

# 构建并推送镜像
build_images:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY_URL
  script:
    # 后端
    - cd easy-to-develop-back
    - mvn clean package -DskipTests # 注意：这里需要在 docker 镜像中包含 maven，或者分阶段传递 artifacts
    # 为了简化，通常使用多阶段 Dockerfile 直接构建，或者先用 maven 镜像构建 jar
    # 这里演示使用 Dockerfile (包含多阶段构建) 直接构建
    - docker build -t $BACKEND_IMAGE:$CI_COMMIT_SHA -t $BACKEND_IMAGE:latest .
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
    
    # 前端
    - cd ../easy-to-develop-admin
    - docker build -t $FRONTEND_IMAGE:$CI_COMMIT_SHA -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest

# 部署 (示例：通过 SSH 部署到目标服务器)
deploy:
  image: docker:latest
  stage: deploy
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        export BACKEND_IMAGE=$BACKEND_IMAGE:$CI_COMMIT_SHA &&
        export FRONTEND_IMAGE=$FRONTEND_IMAGE:$CI_COMMIT_SHA &&
        docker-compose -f docker-compose.ci.yml pull &&
        docker-compose -f docker-compose.ci.yml up -d"
  only:
    - main
